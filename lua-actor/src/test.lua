require("setup")
local crypto = require(".crypto.init")
local es256k = require(".es256k")

local function r(bool)
  if bool then
    return '\x1b[6;30;42m'..'SUCCESS'..'\x1b[0m'
  else
    return '\x1b[0;30;41m'..'FAILURE'..'\x1b[0m'
  end
end

local function measure(work_func, description, expect_false)
  local start_time = os.time()
  local result = work_func()
  local end_time = os.time()
  local elapsed_time = os.difftime(end_time, start_time)
  if expect_false then
    result = not result
  end
  print(description .. ': ' .. r(result) .. ' (' .. elapsed_time .. 's)')
end

-- Veramo passes this in for the signing function to use
local PRIV_KEY = "5a4a285d9e8726c011f20ff4133e0b417894929b3d053903c6831ea6bdc6930d"

-- successfully verified the following JWTs whose signatures work with recovery = 1:
local jwt_r1 = 'eyJhbGciOiJFUzI1NksiLCJ0eXAiOiJKV1QifQ.eyJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7InlvdSI6IlJvY2sifX0sInN1YiI6ImRpZDp3ZWI6ZXhhbXBsZS5jb20iLCJuYmYiOjE3MzQwMjg3ODAsImlzcyI6ImRpZDpldGhyOnNlcG9saWE6MHgwMmM2M2VmZTNkYzcwN2Y2ZTNkMzIzZjExZTQwY2YwNzU3OGIyYWI5YWVlMTYzNWU2ZWU2NzZmNmRhMDlmMTU5OGQifQ.VEHlsQ7rF5Z5lDuQPZjSp2Tsd-QM0tSB5SWBmE_jZppghPpee_pZyzigqsUCeWV9J0rt8SI2oS7uhjm1JaLrww'
-- successfully verified the following JWTs whose signatures work with recovery = 0:
local jwt_r0 = 'eyJhbGciOiJFUzI1NksiLCJ0eXAiOiJKV1QifQ.eyJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7InlvdSI6IlJvY2sifX0sInN1YiI6ImRpZDp3ZWI6ZXhhbXBsZS5jb20iLCJuYmYiOjE3MzQwMjgzMjIsImlzcyI6ImRpZDpldGhyOnNlcG9saWE6MHgwMmM2M2VmZTNkYzcwN2Y2ZTNkMzIzZjExZTQwY2YwNzU3OGIyYWI5YWVlMTYzNWU2ZWU2NzZmNmRhMDlmMTU5OGQifQ.VEHlsQ7rF5Z5lDuQPZjSp2Tsd-QM0tSB5SWBmE_jZpobbzDaKg1GPoAtZLBeoWwdNfjTxiyhyY08iYw3mCV4rg'
local jwt_r0_invalid = 'eyJhbGciOiJFUzI1NksiLCJ0eXAiOiJKV1QifQ.eyJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7InlvdSI6IlJvY2tzb3JzIn19LCJzdWIiOiJkaWQ6d2ViOmV4YW1wbGUuY29tIiwibmJmIjoxNzM0MDI4MzIyLCJpc3MiOiJkaWQ6ZXRocjpzZXBvbGlhOjB4MDJjNjNlZmUzZGM3MDdmNmUzZDMyM2YxMWU0MGNmMDc1NzhiMmFiOWFlZTE2MzVlNmVlNjc2ZjZkYTA5ZjE1OThkIn0=.VEHlsQ7rF5Z5lDuQPZjSp2Tsd-QM0tSB5SWBmE_jZpobbzDaKg1GPoAtZLBeoWwdNfjTxiyhyY08iYw3mCV4rg'
-- local jwt = "eyJhbGciOiJFUzI1NksiLCJ0eXAiOiJKV1QifQ.eyJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7InlvdSI6IlJvY2sifX0sInN1YiI6ImRpZDp3ZWI6ZXhhbXBsZS5jb20iLCJuYmYiOjE3MzQwMjQyMjAsImlzcyI6ImRpZDpldGhyOnNlcG9saWE6MHgwMmM2M2VmZTNkYzcwN2Y2ZTNkMzIzZjExZTQwY2YwNzU3OGIyYWI5YWVlMTYzNWU2ZWU2NzZmNmRhMDlmMTU5OGQifQ.VEHlsQ7rF5Z5lDuQPZjSp2Tsd-QM0tSB5SWBmE_jZpom4Z7KNHlAkWyWF2go-Hklx2sD9xWFYV-Rr_pjjpRP_Q"
-- local jwt = 'eyJhbGciOiJFUzI1NksiLCJ0eXAiOiJKV1QifQ.eyJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7InlvdSI6IlJvY2sifX0sInN1YiI6ImRpZDp3ZWI6ZXhhbXBsZS5jb20iLCJuYmYiOjE3MzM1NDA2ODQsImlzcyI6ImRpZDpldGhyOnNlcG9saWE6MHgwMmM2M2VmZTNkYzcwN2Y2ZTNkMzIzZjExZTQwY2YwNzU3OGIyYWI5YWVlMTYzNWU2ZWU2NzZmNmRhMDlmMTU5OGQifQ.VEHlsQ7rF5Z5lDuQPZjSp2Tsd-QM0tSB5SWBmE_jZpoJw-qwrAFGMpFOiDqJzqqcXZCuUif-mJlxVhxeXCmbjA'


measure(function() return es256k.jwt_validate(jwt_r0) end, 'Validating a JWT with recovery=0')

measure(function() return es256k.jwt_validate(jwt_r1) end, 'Validating a JWT with recovery=1')

measure(function() return es256k.jwt_validate(jwt_r0_invalid) end, 'Validating am invalid JWT with recovery=0', true)

-- successfully managed to sign and verify this input:
local msg = 'eyJhbGciOiJFUzI1NksiLCJ0eXAiOiJKV1QifQ.eyJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7InlvdSI6IlJvY2sifX0sInN1YiI6ImRpZDp3ZWI6ZXhhbXBsZS5jb20iLCJuYmYiOjE3MzM1NDA2ODQsImlzcyI6ImRpZDpldGhyOnNlcG9saWE6MHgwMmM2M2VmZTNkYzcwN2Y2ZTNkMzIzZjExZTQwY2YwNzU3OGIyYWI5YWVlMTYzNWU2ZWU2NzZmNmRhMDlmMTU5OGQifQ'

-- TODO: this one seems to fail, can't remember why anymore
-- measure(function()
--   local msg_stream = crypto.utils.stream.fromString(msg);
--   local msg_hash_hex = crypto.digest.sha2_256(msg_stream).asHex();
--   local sig = es256k.create_sig(msg_hash_hex, PRIV_KEY)
--   return es256k.verify_sig(msg_hash_hex, sig, '0x2a6ffb5341f8c1ce123343162e3351f1b6286c43')
-- end, 'Signing input and verifying signature with recovery??')

local eip712_vc_vlad = '{"issuer":{"id":"did:ethr:sepolia:0x02c63efe3dc707f6e3d323f11e40cf07578b2ab9aee1635e6ee676f6da09f1598d"},"credentialSubject":{"agree":"to disagree","foo":"bar","signatories":["0xa5b32d4387138b6a6f8995b961742b494bbfdfeb"]},"issuanceDate":"2025-01-14T00:47:01.538Z","@context":["https://www.w3.org/2018/credentials/v1"],"type":["VerifiableCredential"],"proof":{"verificationMethod":"did:ethr:sepolia:0x02c63efe3dc707f6e3d323f11e40cf07578b2ab9aee1635e6ee676f6da09f1598d#controller","created":"2025-01-14T00:47:01.538Z","proofPurpose":"assertionMethod","type":"EthereumEip712Signature2021","proofValue":"0x279051dcaadcd3fbec8e446d9820fa6756bfac67d1aa8885b6db4a76241bd279160352b28f2bb5a523ab842204fddc98cc91ab138f2cd8496eac60ddcbd796ee1b","eip712":{"domain":{"chainId":11155111,"name":"VerifiableCredential","version":"1"},"types":{"EIP712Domain":[{"name":"name","type":"string"},{"name":"version","type":"string"},{"name":"chainId","type":"uint256"}],"CredentialSubject":[{"name":"agree","type":"string"},{"name":"foo","type":"string"},{"name":"signatories","type":"string[]"}],"Issuer":[{"name":"id","type":"string"}],"Proof":[{"name":"created","type":"string"},{"name":"proofPurpose","type":"string"},{"name":"type","type":"string"},{"name":"verificationMethod","type":"string"}],"VerifiableCredential":[{"name":"@context","type":"string[]"},{"name":"credentialSubject","type":"CredentialSubject"},{"name":"issuanceDate","type":"string"},{"name":"issuer","type":"Issuer"},{"name":"proof","type":"Proof"},{"name":"type","type":"string[]"}]},"primaryType":"VerifiableCredential"}}}'

measure(function()
  return es256k.vc_validate(eip712_vc_vlad)
end, 'Verifying Vlad\'s VC with a EthereumEip712Signature2021 signature')

local eip712_vc_jerry = '{"id":"c7b19a48-b664-425d-ae24-5e42dcf943bf","issuer":{"id":"did:pkh:eip155:1:0x1e8564A52fc67A68fEe78Fc6422F19c07cFae198"},"@context":["https://www.w3.org/2018/credentials/v1"],"type":["VerifiableCredential","SignedAgreement"],"issuanceDate":"2025-01-13T18:04:28.879Z","credentialSubject":{"id":"did:pkh:eip155:1:0x1e8564A52fc67A68fEe78Fc6422F19c07cFae198","documentHash":"0x8964d34dda2371369e03231148a9fcc3c29d991ed68967690f11e2eca92c3ecd","timeStamp":"2025-01-13T18:04:28.880Z"},"proof":{"verificationMethod":"did:pkh:eip155:1:0x1e8564A52fc67A68fEe78Fc6422F19c07cFae198#blockchainAccountId","created":"2025-01-13T18:04:28.879Z","proofPurpose":"assertionMethod","type":"EthereumEip712Signature2021","proofValue":"0x410938df9302264517da4aa2874d2fcc82553a115b500ef90356df6c6df939537784eee09d113b1a1bc7c3cb00b900a37e8e45d0901e11bf3f1430f6182be3ad1c","eip712":{"domain":{"chainId":1,"name":"VerifiableCredential","version":"1"},"types":{"EIP712Domain":[{"name":"name","type":"string"},{"name":"version","type":"string"},{"name":"chainId","type":"uint256"}],"CredentialSubject":[{"name":"documentHash","type":"string"},{"name":"id","type":"string"},{"name":"timeStamp","type":"string"}],"Issuer":[{"name":"id","type":"string"}],"Proof":[{"name":"created","type":"string"},{"name":"proofPurpose","type":"string"},{"name":"type","type":"string"},{"name":"verificationMethod","type":"string"}],"VerifiableCredential":[{"name":"@context","type":"string[]"},{"name":"credentialSubject","type":"CredentialSubject"},{"name":"id","type":"string"},{"name":"issuanceDate","type":"string"},{"name":"issuer","type":"Issuer"},{"name":"proof","type":"Proof"},{"name":"type","type":"string[]"}]},"primaryType":"VerifiableCredential"}}}'

measure(function()
  return es256k.vc_validate(eip712_vc_jerry)
end, 'Verifying Jerry\'s VC with a EthereumEip712Signature2021 signature')

local eip712_vc_jerry_full_doc = '{"id":"97d39e57-d406-4560-8b1a-e74250a008e6","issuer":{"id":"did:pkh:eip155:1:0x1e8564A52fc67A68fEe78Fc6422F19c07cFae198"},"@context":["https://www.w3.org/2018/credentials/v1"],"type":["VerifiableCredential","Agreement"],"issuanceDate":"2025-01-15T19:47:18.725Z","credentialSubject":{"id":"did:pkh:eip155:1:0x1e8564A52fc67A68fEe78Fc6422F19c07cFae198","document":"W3siaWQiOiI1Mjg1MGM0Zi1jZjdiLTQ1ZTgtODM4OC03ODVkNGQzZTEyYmUiLCJ0eXBlIjoiaGVhZGluZyIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQiLCJsZXZlbCI6MX0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IkdyYW50IEFncmVlbWVudCIsInN0eWxlcyI6eyJib2xkIjp0cnVlfX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiI1NDkwMjA5NC1hMTFiLTQ5NTktOTkxZC1iMDQxNTEzYmU5MGQiLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbXSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiYmE0NWU1NmUtZDA4OS00NzM5LWFjNDQtMDcyYjE2OTE4YjZiIiwidHlwZSI6InBhcmFncmFwaCIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQifSwiY29udGVudCI6W3sidHlwZSI6InRleHQiLCJ0ZXh0IjoiVGhpcyBHcmFudCBBZ3JlZW1lbnQgKCIsInN0eWxlcyI6e319LHsidHlwZSI6InRleHQiLCJ0ZXh0Ijoi4oCcQWdyZWVtZW504oCdIiwic3R5bGVzIjp7ImJvbGQiOnRydWV9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IikgaXMgZW50ZXJlZCBpbnRvIG9uIDxTZWxlY3QgRGF0ZT4gLCAodGhlICIsInN0eWxlcyI6e319LHsidHlwZSI6InRleHQiLCJ0ZXh0Ijoi4oCcRWZmZWN0aXZlIERhdGXigJ0iLCJzdHlsZXMiOnsiYm9sZCI6dHJ1ZX19LHsidHlwZSI6InRleHQiLCJ0ZXh0IjoiKSwgYmV0d2VlbiBFY29zeXN0ZW0gTmFtZSBGb3VuZGF0aW9uLCBhIEp1cmlzZGljdGlvbiBmb3VuZGF0aW9uIGNvbXBhbnkgKHRoZSAiLCJzdHlsZXMiOnt9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IuKAnEZvdW5kYXRpb27igJ0iLCJzdHlsZXMiOnsiYm9sZCI6dHJ1ZX19LHsidHlwZSI6InRleHQiLCJ0ZXh0IjoiKXdpdGggRDMgYWRkcmVzcyA8U2VsZWN0IEQzIElEPiAsIGFuZCA8R3JhbnQgUmVjaXBpZW50IE5hbWU+ICwgYW4gaW5kaXZpZHVhbCB3aXRoIGFkZHJlc3MgPFNlbGVjdCBEMyBJRD4gKCIsInN0eWxlcyI6e319LHsidHlwZSI6InRleHQiLCJ0ZXh0Ijoi4oCcR3JhbnQgUmVjaXBpZW504oCdIiwic3R5bGVzIjp7ImJvbGQiOnRydWV9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IikuIiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiJiMDFjYzNiZC1jNGVlLTRjNDAtYThiNS1mYjU4N2I5ZmY5ZjYiLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbXSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiZDlkNTkyYTQtYWU0Ny00MzlhLTgyMjAtZDE2MTUzYjJjZmM1IiwidHlwZSI6InBhcmFncmFwaCIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQifSwiY29udGVudCI6W3sidHlwZSI6InRleHQiLCJ0ZXh0IjoiVGhlIEZvdW5kYXRpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQsIGluIHBhcnQsIHRvIGhlbHAgcHJvbW90ZSBncm93dGggb2YgdGhlIDxFY29zeXN0ZW0gTmFtZT4gZWNvc3lzdGVtIGFuZCBzZWVrcyB0byBhd2FyZCBncmFudHMgdG8gcHJvbW90ZSBkZXZlbG9wbWVudCBjb25zaXN0ZW50IHdpdGggdGhlIGNvbGxlY3RpdmUgZGVjaXNpb24gbWFraW5nIG9mIHRoZSA8V09SSz4gdG9rZW4gKCIsInN0eWxlcyI6e319LHsidHlwZSI6InRleHQiLCJ0ZXh0Ijoi4oCcV09SS+KAnSIsInN0eWxlcyI6eyJib2xkIjp0cnVlfX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiIpIGhvbGRlciBjb21tdW5pdHkgKHRoZSAiLCJzdHlsZXMiOnt9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IuKAnFdPUksgQ29tbXVuaXR54oCdIiwic3R5bGVzIjp7ImJvbGQiOnRydWV9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IikuXG4iLCJzdHlsZXMiOnt9fV0sImNoaWxkcmVuIjpbXX0seyJpZCI6ImU5OWEyODIwLWU1YWUtNGVhNS05MDBkLTdkZmE3Y2M0ODY2NiIsInR5cGUiOiJwYXJhZ3JhcGgiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IlRoZSBHcmFudCBSZWNpcGllbnQgaGFzIGJlZW4gc2VsZWN0ZWQgYnkgdGhlIEZvdW5kYXRpb24gRGVzaWduYXRlZCBUb2tlbiBBbGxvY2F0b3IgPERXQVQgTmFtZT4gKCIsInN0eWxlcyI6e319LHsidHlwZSI6InRleHQiLCJ0ZXh0Ijoi4oCcVG9rZW4gQWxsb2NhdG9y4oCdIiwic3R5bGVzIjp7ImJvbGQiOnRydWV9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6Iikgd2l0aCBhZGRyZXNzIDxTZWxlY3QgRDMgSUQ+IHRvIHJlY2VpdmUgYSBncmFudCBzdWJqZWN0IGFuZCBpbiBhY2NvcmRhbmNlIHdpdGggdGhlIHRlcm1zIGFuZCBjb25kaXRpb25zIG9mIHRoaXMgQWdyZWVtZW50LlxuIiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiJkZDBmNDQxYS05MGY2LTRkNTQtODNiYS03NzZkODAwY2FiYjgiLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbeyJ0eXBlIjoidGV4dCIsInRleHQiOiJUSEVSRUZPUkUsIHRoZSBwYXJ0aWVzIGFncmVlIGFzIGZvbGxvd3M6XG4iLCJzdHlsZXMiOnt9fV0sImNoaWxkcmVuIjpbXX0seyJpZCI6ImE5ZTk4MDFlLWYwNTItNDQ2Ny05OWI1LTQyMGY1YWIwZTA3YSIsInR5cGUiOiJwYXJhZ3JhcGgiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IjEuIEdSQU5UIFJFQ0lQSUVOVCBBQ1RJVklUSUVTXG4iLCJzdHlsZXMiOnsiYm9sZCI6dHJ1ZX19XSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiM2NiMGExOGMtMGU2Yi00YTIzLWIyMTktNTQ4NTdjMDg4OGQyIiwidHlwZSI6InBhcmFncmFwaCIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQifSwiY29udGVudCI6W3sidHlwZSI6InRleHQiLCJ0ZXh0IjoiMS4xICIsInN0eWxlcyI6e319LHsidHlwZSI6InRleHQiLCJ0ZXh0IjoiR3JhbnRzIiwic3R5bGVzIjp7InVuZGVybGluZSI6dHJ1ZX19LHsidHlwZSI6InRleHQiLCJ0ZXh0IjoiLiBGb3VuZGF0aW9uIGFuZCBHcmFudCBSZWNpcGllbnQgYXJlIGVudGVyaW5nIGludG8gdGhpcyBBZ3JlZW1lbnQgaW4gY29ubmVjdGlvbiB3aXRoIFJGUCM6IDxXUkZQIE51bWJlcj4gLCBhcyBzZXQgZm9ydGggYXQgPFNlbGVjdCBEMyBMaW5rPiAsIHdoaWNoIGRlc2NyaWJlcyB0aGUgc3BlY2lmaWMgYWN0aXZpdGllcyB0byBiZSBwZXJmb3JtZWQgYnkgR3JhbnQgUmVjaXBpZW50ICh0aGUiLCJzdHlsZXMiOnt9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IiDigJxHcmFudOKAnSIsInN0eWxlcyI6eyJib2xkIjp0cnVlfX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiIpLlxuIiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiIxZDBhYjEyZC1lNDQwLTQwOTgtODRlYy1mMTk1MTg2ZjBmZTciLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbeyJ0eXBlIjoidGV4dCIsInRleHQiOiIxLjIgIiwic3R5bGVzIjp7fX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiJQZXJmb3JtYW5jZSBvZiBHcmFudCBSZWNpcGllbnQgQWN0aXZpdGllcy4iLCJzdHlsZXMiOnsidW5kZXJsaW5lIjp0cnVlfX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiIgR3JhbnQgUmVjaXBpZW50IHdpbGwgcGVyZm9ybSB0aGUgYWN0aXZpdGllcyBkZXNjcmliZWQgaW4gdGhlIEdyYW50ICh0aGUgIiwic3R5bGVzIjp7fX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiLigJxHcmFudCBSZWNpcGllbnQgQWN0aXZpdGllc+KAnSIsInN0eWxlcyI6eyJib2xkIjp0cnVlfX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiIpIGluIGFjY29yZGFuY2Ugd2l0aCB0aGUgdGVybXMgYW5kIGNvbmRpdGlvbnMgc2V0IGZvcnRoIGluIGVhY2ggc3VjaCBHcmFudCBhbmQgdGhpcyBBZ3JlZW1lbnQgYW5kIHdpdGggYW55IGFwcGxpY2FibGUgbGF3cy4gR3JhbnQgUmVjaXBpZW50IHdpbGwgbm90IHBhcnRpY2lwYXRlIGluIG9yIGVuY291cmFnZSBhbnkgYXR0YWNrcyBvbiB0aGUgV29ya1Rva2VuIENvbW11bml0eSwgaW5jbHVkaW5nIGJ1dCBub3QgbGltaXRlZCB0bzoiLCJzdHlsZXMiOnt9fV0sImNoaWxkcmVuIjpbXX0seyJpZCI6IjdhMmFjNTFmLWVjOGMtNGQ1NS1hY2M0LTc4YjZmY2U5OThkNyIsInR5cGUiOiJidWxsZXRMaXN0SXRlbSIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQifSwiY29udGVudCI6W3sidHlwZSI6InRleHQiLCJ0ZXh0IjoiVGVjaG5pY2FsIGF0dGFja3MsIGhhY2tpbmcsIHRoZWZ0IG9mIHRoZSBXT1JLIENvbW11bml0eSBmdW5kcywgb3IgZnJhdWQsIiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiIwMzUwZTkxMC1kZmM0LTQ3Y2QtYmI3MS00MWJmYzlhZGE5ZjAiLCJ0eXBlIjoiYnVsbGV0TGlzdEl0ZW0iLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IkFueSBjb25kdWN0IHJlYXNvbmFibHkgYW50aWNpcGF0ZWQgdG8gY2F1c2UgaGFybSB0byB0aGUgV09SSyBDb21tdW5pdHkgb3IgdGhlIEZvdW5kYXRpb24sIG9yIiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiJjZDY3MDZmMS1hMDY4LTQ4M2UtYmIyYy0xZGMxMjUwZGNmOTYiLCJ0eXBlIjoiYnVsbGV0TGlzdEl0ZW0iLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IkFueSBvdGhlciBhY3Rpdml0eSB0aGF0IEZvdW5kYXRpb24gY29uc2lkZXJzIHRvIGJlIG1hbGljaW91cyBvciB1bmxhd2Z1bCBhY3Rpdml0eSwgaW4gaXRzIHNvbGUgZGlzY3JldGlvbi4iLCJzdHlsZXMiOnt9fV0sImNoaWxkcmVuIjpbXX0seyJpZCI6ImM1NmU5MGZhLWIzNmYtNDAyNi05MzZjLTY1MzJkYjFmMjRmMSIsInR5cGUiOiJwYXJhZ3JhcGgiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOltdLCJjaGlsZHJlbiI6W119LHsiaWQiOiJhN2I0NjY4Yi1kNDY1LTRlN2YtOTBmZS1kMGIwN2FhNjJlYjciLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbeyJ0eXBlIjoidGV4dCIsInRleHQiOiIyLiBHUkFOVCBESVNUUklCVVRJT05cbiIsInN0eWxlcyI6eyJib2xkIjp0cnVlfX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiJkMTJjNDZkOS01MDNjLTRkZWEtOWMyNC0wMzIzMDNiZDMzNWIiLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbeyJ0eXBlIjoidGV4dCIsInRleHQiOiJUaGUgVG9rZW4gQWxsb2NhdG9yIHdpbGwgcGF5IEdyYW50IFJlY2lwaWVudCBvbiBiZWhhbGYgb2YgdGhlIEZvdW5kYXRpb24gdGhlIGFtb3VudHMgc3BlY2lmaWVkIGluIGVhY2ggR3JhbnQgaW4gYWNjb3JkYW5jZSB3aXRoIHRoZSB0ZXJtcyBzZXQgZm9ydGggaW4gIiwic3R5bGVzIjp7fX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiJTQ0hFRFVMRSBBIiwic3R5bGVzIjp7ImJvbGQiOnRydWV9fSx7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IiAodGhlICIsInN0eWxlcyI6e319LHsidHlwZSI6InRleHQiLCJ0ZXh0Ijoi4oCcUGF5bWVudCBTY2hlZHVsZeKAnSIsInN0eWxlcyI6eyJib2xkIjp0cnVlfX0seyJ0eXBlIjoidGV4dCIsInRleHQiOiIpIHRoZXJlaW4gdXNpbmc6Iiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiI3Y2EzMTNlMi00NzJkLTQ5ZTYtOTlhMi1iMjJmNjU2MDgxYzgiLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbXSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiMWZlMTU4NzUtMDg0MC00MjI4LTk2YWEtM2U0YzZjYjY5OTg2IiwidHlwZSI6InNhYmxpZXIiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQiLCJzaGFwZSI6Im1vbnRobHkiLCJjaGFpbiI6MSwidG9rZW4iOiIiLCJhbW91bnQiOjAsImR1cmF0aW9uIjoxLCJmaXJzdFVubG9jayI6ImRlZmF1bHQifSwiY29udGVudCI6W3sidHlwZSI6InRleHQiLCJ0ZXh0IjoiVGVzdCIsInN0eWxlcyI6e319XSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiNmUzNDQ3YzMtMjlkZi00ZjVmLWE3ZTMtOWNjMDA1ODQzNjEyIiwidHlwZSI6InBhcmFncmFwaCIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQifSwiY29udGVudCI6W10sImNoaWxkcmVuIjpbXX0seyJpZCI6ImIyMmNiZjBlLWY2ODgtNDgwNy04MWY0LTNmZTgzNGZjODM1ZiIsInR5cGUiOiJwYXJhZ3JhcGgiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IkFsbCBvdGhlciBhbW91bnRzIHNldCBmb3J0aCBpbiB0aGUgR3JhbnQsIGlmIGFueSwgYXJlIHN0YXRlZCBpbiBhbmQgYXJlIHBheWFibGUgaW4gV09SSy4gVGhlIHBhcnRpZXMgd2lsbCB1c2UgdGhlaXIgcmVzcGVjdGl2ZSBjb21tZXJjaWFsbHkgcmVhc29uYWJsZSBlZmZvcnRzIHRvIHByb21wdGx5IHJlc29sdmUgYW55IHBheW1lbnQgZGlzcHV0ZXMuIEdyYW50IFJlY2lwaWVudCB1bmRlcnN0YW5kcyBhbmQgYWNrbm93bGVkZ2VzIHRoYXQ6Iiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiI4NjhjZmI1OC1hMzE0LTQ4ZDItODYwOC1hMjcxOTY1NjFlYTgiLCJ0eXBlIjoiYnVsbGV0TGlzdEl0ZW0iLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IkZvdW5kYXRpb24gd2lsbCBub3QgYmUgaW52b2x2ZWQgaW4gdGhlIG9wZXJhdGlvbiBvZiBhbnkgR3JhbnQgUmVjaXBpZW50IEFjdGl2aXRpZXM7Iiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiI4OTBkMGE1Yy1mZjVmLTRhNWQtOTVjOC02ZjM3YmRhMzZlZWUiLCJ0eXBlIjoiYnVsbGV0TGlzdEl0ZW0iLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IkJ5IHByb3ZpZGluZyB0aGUgR3JhbnQsIEZvdW5kYXRpb24gaXMgb25seSBncmFudGluZyBXT1JLIHRvIEdyYW50IFJlY2lwaWVudCBhbmQgaXMgbm90IGNvbmR1Y3RpbmcgYW55IEdyYW50IFJlY2lwaWVudCBBY3Rpdml0aWVzOyIsInN0eWxlcyI6e319XSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiMzA4MzFhYjctM2Y1Ny00ZjAzLWJmMjYtYzc4OGRhOTBlNWJlIiwidHlwZSI6ImJ1bGxldExpc3RJdGVtIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbeyJ0eXBlIjoidGV4dCIsInRleHQiOiJGb3VuZGF0aW9uIGlzIG5vdCwgYW5kIHdpbGwgbm90IGJlLCByZWdpc3RlcmVkIGFzIGEgdmlydHVhbCBhc3NldCBzZXJ2aWNlIHByb3ZpZGVyIHVuZGVyIHRoZSBWaXJ0dWFsIEFzc2V0cyBTZXJ2aWNlcyBQcm92aWRlcnMgQWN0IG9mIHRoZSBbSnVyaXNkaWN0aW9uXSBhbmQgdGhlIFdPUksgdG9rZW5zIGhhdmUgbm90IGJlZW4sIGFuZCB3aWxsIG5vdCBiZSwgcmVnaXN0ZXJlZCB3aXRoIHRoZSBbSnVyaXNkaWN0aW9uXSBNb25ldGFyeSBBdXRob3JpdHk7IGFuZCIsInN0eWxlcyI6e319XSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiYTk5NzhiZDMtYTZjMC00ODM2LWFkNTItMzkyZmNhZmQzMGNlIiwidHlwZSI6ImJ1bGxldExpc3RJdGVtIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbeyJ0eXBlIjoidGV4dCIsInRleHQiOiJUaGlzIEFncmVlbWVudCBkb2VzIG5vdCBjb25zdGl0dXRlIGEgc2FsZSBvZiB2aXJ0dWFsIGFzc2V0cyB0byB0aGUgcHVibGljLiIsInN0eWxlcyI6e319XSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiNGUwMjE1MmQtYjM2YS00OGRjLWE0MDctOGJjNjUzZGRiMDRmIiwidHlwZSI6InBhcmFncmFwaCIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQifSwiY29udGVudCI6W10sImNoaWxkcmVuIjpbXX0seyJpZCI6IjdmMzhmZGMzLTYzYmUtNGI1ZS05OWRlLWFkMjE2Y2M2ZTJmZiIsInR5cGUiOiJwYXJhZ3JhcGgiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IklOIFdJVE5FU1MgV0hFUkVPRiwgdGhlIEdyYW50IFJlY2lwaWVudCBoYXMgZXhlY3V0ZWQgdGhpcyBBZ3JlZW1lbnQgb24gdGhlIGRhdGUgZmlyc3Qgd3JpdHRlbiBhYm92ZS5cbiIsInN0eWxlcyI6e319XSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiNGUyYTdmMmMtYWNmYi00NTVkLWI1NTAtYzRkYjBiZmRkNDgyIiwidHlwZSI6InNpZ25hdHVyZSIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbXSwiY2hpbGRyZW4iOltdfSx7ImlkIjoiMTUxMzM5ZTMtMjQ4Zi00Y2E2LWE4ZmYtYzRiYWE3ZGEwZTkzIiwidHlwZSI6InBhcmFncmFwaCIsInByb3BzIjp7InRleHRDb2xvciI6ImRlZmF1bHQiLCJiYWNrZ3JvdW5kQ29sb3IiOiJkZWZhdWx0IiwidGV4dEFsaWdubWVudCI6ImxlZnQifSwiY29udGVudCI6W3sidHlwZSI6InRleHQiLCJ0ZXh0IjoiTmFtZTogU3VwQzBEM1IiLCJzdHlsZXMiOnt9fV0sImNoaWxkcmVuIjpbXX0seyJpZCI6IjcwZTA4OWRhLWJhZGYtNDdkMC1hMmM3LTBkZjgxNzdlZmFkNiIsInR5cGUiOiJwYXJhZ3JhcGgiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IlRpdGxlOiBUZWNoIExlYWQiLCJzdHlsZXMiOnt9fV0sImNoaWxkcmVuIjpbXX0seyJpZCI6IjQ4MDZmZGJlLWEyYWMtNDE1ZC1hYmQ5LWM0NjllNTM5NmM3OSIsInR5cGUiOiJwYXJhZ3JhcGgiLCJwcm9wcyI6eyJ0ZXh0Q29sb3IiOiJkZWZhdWx0IiwiYmFja2dyb3VuZENvbG9yIjoiZGVmYXVsdCIsInRleHRBbGlnbm1lbnQiOiJsZWZ0In0sImNvbnRlbnQiOlt7InR5cGUiOiJ0ZXh0IiwidGV4dCI6IlxuIiwic3R5bGVzIjp7fX1dLCJjaGlsZHJlbiI6W119LHsiaWQiOiJmNmRmY2Q4ZC05YjZiLTQwODItOTZhYS1kY2JlODE0MjQ1ZDgiLCJ0eXBlIjoicGFyYWdyYXBoIiwicHJvcHMiOnsidGV4dENvbG9yIjoiZGVmYXVsdCIsImJhY2tncm91bmRDb2xvciI6ImRlZmF1bHQiLCJ0ZXh0QWxpZ25tZW50IjoibGVmdCJ9LCJjb250ZW50IjpbXSwiY2hpbGRyZW4iOltdfV0=","timeStamp":"2025-01-15T19:47:18.726Z"},"proof":{"verificationMethod":"did:pkh:eip155:1:0x1e8564A52fc67A68fEe78Fc6422F19c07cFae198#blockchainAccountId","created":"2025-01-15T19:47:18.725Z","proofPurpose":"assertionMethod","type":"EthereumEip712Signature2021","proofValue":"0x7b2c6055e7ef2ff5251cf924920e6556c8a8f011711b39e61689f12e940158c933177f026e9509d49d3a1686c7ba763591e1ccb37f97ce9d535a54b6a9e623331c","eip712":{"domain":{"chainId":1,"name":"VerifiableCredential","version":"1"},"types":{"EIP712Domain":[{"name":"name","type":"string"},{"name":"version","type":"string"},{"name":"chainId","type":"uint256"}],"CredentialSubject":[{"name":"document","type":"string"},{"name":"id","type":"string"},{"name":"timeStamp","type":"string"}],"Issuer":[{"name":"id","type":"string"}],"Proof":[{"name":"created","type":"string"},{"name":"proofPurpose","type":"string"},{"name":"type","type":"string"},{"name":"verificationMethod","type":"string"}],"VerifiableCredential":[{"name":"@context","type":"string[]"},{"name":"credentialSubject","type":"CredentialSubject"},{"name":"id","type":"string"},{"name":"issuanceDate","type":"string"},{"name":"issuer","type":"Issuer"},{"name":"proof","type":"Proof"},{"name":"type","type":"string[]"}]},"primaryType":"VerifiableCredential"}}}'

measure(function()
  return es256k.vc_validate(eip712_vc_jerry_full_doc)
end, 'Verifying Jerry\'s full doc VC with a EthereumEip712Signature2021 signature')